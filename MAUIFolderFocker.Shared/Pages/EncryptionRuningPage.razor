@using MAUIFolderFocker.Shared.Service.IO.Services
@using MAUIFolderFocker.Shared.Services.Comunication.Variables
@using MAUIFolderFocker.Shared.Services.CryptoLogic.Service
@using MAUIFolderFocker.Shared.Services.Variables
@using Service.CryptoLogic.Service
@using Service.CryptoLogic.Models

@inject SingletonDataToEncrypt Shared

@page "/encryption-running-page"

<h3>EncryptionRuningPage</h3>

<div class="card">
    <div class="card-body">
        <h3 class="card-title">UI Encrypt Options</h3>

        <ul class="list-group">
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
        </ul>
        @* <button class="btn btn-primary" @onclick="(() => Encrypt())">Encrypt Data</button> *@
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5>Postęp szyfrowania</h5>
        <div class="progress mb-2">
            <div class="progress-bar" role="progressbar" style="width: @ProgressPercent%;">@ProgressPercent%</div>
        </div>
        <button class="btn btn-primary" @onclick="StartEncryption" disabled="@IsEncrypting">Start Encrypt</button>
        <div class="mt-3">
            <h5>Zakodowane pliki:</h5>
            <ul>
                @foreach (var result in Results)
                {
                    <li>
                        @(result.Success ? "✅" : "❌") @result.SuccessMessage @result.ErrorMessage
                    </li>
                }
            </ul>
        </div>
    </div>
</div>


<p>Current Progress: @progress%</p>
<ul>
    @foreach (var result in encryptResults)
    {
        <li>@result.SuccessMessage @result.ErrorMessage</li>
    }
</ul>

@code {
    [Parameter]
    public List<FileClass>? SelectedFiles { get; set; }
    [Parameter] public string DirectoryPath { get; set; }
    [Parameter]
    public string DirectoryName { get; set; }
    [Parameter]
    public string? SavePath { get; set; }
    [Parameter]
    public string? Password { get; set; }
    [Parameter]
    public ModelOptions Model { get; set; }

    private EventCallback<int> OnProgressChanged { get; set; }
    private EventCallback<List<EncryptResult>> OnResultsChanged { get; set; }

    private EncryptService encryptService = new();
    private EncryptionOptions encryptOptions = new();
    private KeyDerivationService keyDerivationService = new();
    private FileEdit fileEdit = new();

    private int EncryptAlgorytm = -1;
    private int MinPsswordSize = 4;
    // private int maxkeySize = 64;

    private string FileName { get; set; }
    // private string Nonce { get; set; }

    private byte[] FileData { get; set; }
    private byte[] EncryptResult { get; set; }

    private string FileHead { get; set; } = string.Empty;
    private string SaveDirectory { get; set; } = string.Empty;

    // private byte[] keyBytes { get; set; }
    // private byte[] salt { get; set; }
    // private byte[] nonce { get; set; }

    protected override void OnInitialized()
    {

        StartEncryption();
    }

    private int FileCurrent { get; set; }
    private int FilesTotal { get; set; }
    private int ProgressPercent { get; set; }
    private bool IsEncrypting { get; set; }
    private List<EncryptResult> Results { get; set; } = new();
    private EncryptResult Result { get; set; }

    private async Task StartEncryption()
    {
        if (Shared == null) return;
        if (Shared.SelectedFiles == null || Shared.SelectedFiles.Count == 0) return;
        if (Shared.NewDirectoryName == null) return;
        if (Shared.SavePath == null || !Directory.Exists(Shared.SavePath)) return;
        if (Shared.Password == null || Shared.Password.Length <= MinPsswordSize) return;

        IsEncrypting = true;
        Results.Clear();

        // Define the onProgress callback here to fix CS0103
        Action<int, int, EncryptResult> onProgress = (fileCurrent, filesTotal, result) =>
        {
            FileCurrent = fileCurrent;
            FilesTotal = filesTotal;
            ProgressPercent = (int)((fileCurrent / (double)filesTotal) * 100);
            Result = result;
            Results.Add(result);
            StateHasChanged();
        };

        switch(Model)
        {
            case ModelOptions.ChaCha20:
                // Results = await encryptService.Encrypt(SelectedFiles, Model, SavePath, DirectoryName, Password, onProgress);
                Results = await encryptService.Encrypt(Shared.SelectedFiles, Shared.Model, Shared.SavePath,
                    Shared.NewDirectoryName, Shared.Password, onProgress);
                break;
            // case ModelOptions.AES_GCM:
            //     EncryptAlgorytm = (int)EncryptOptions.AES_GCM;
            //     break;
            // case ModelOptions.AES_CBC:
            //     EncryptAlgorytm = (int)EncryptOptions.AES_CBC;
            //     break;
            default:
                // Results = await encryptService.Encrypt(SelectedFiles, Model, SavePath, DirectoryName, Password, onProgress);
                Results = await encryptService.Encrypt(Shared.SelectedFiles, Shared.Model, Shared.SavePath,
                    Shared.NewDirectoryName, Shared.Password, onProgress);
                break;
        }
    }

    private int progress = 0;
    private List<EncryptResult> encryptResults = new();

    private void HandleProgress(int value) => progress = value;
    private void HandleResults(List<EncryptResult> results) => encryptResults = results;
}
